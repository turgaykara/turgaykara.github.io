<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dark Security | Debug Modu</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        :root { --bg-body: #09090b; --primary: #8b5cf6; --text-main: #f4f4f5; --bg-input: #3f3f46; --border: rgba(255,255,255,0.08); }
        * { box-sizing: border-box; outline: none; }
        body { margin: 0; font-family: 'Inter', sans-serif; background-color: var(--bg-body); color: var(--text-main); height: 100vh; display: flex; overflow: hidden; }
        
        /* Basitleştirilmiş CSS */
        .sidebar { width: 260px; background: #18181b; border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 24px; flex-shrink: 0; }
        .main { flex-grow: 1; display: flex; flex-direction: column; height: 100vh; overflow: hidden; position: relative; }
        .header { height: 60px; border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 32px; font-weight: bold; }
        .chat-area { flex-grow: 1; overflow-y: auto; padding: 32px; display: flex; flex-direction: column; scroll-behavior: smooth; }
        
        /* Input Bar */
        .chat-input-bar { flex-shrink: 0; background: #18181b; border-top: 1px solid var(--border); padding: 20px; display: flex; gap: 10px; }
        .chat-input { flex-grow: 1; background: var(--bg-input); border: none; padding: 10px; color: white; border-radius: 8px; resize: none; height: 50px; }
        .send-btn { width: 50px; background: var(--primary); border: none; color: white; border-radius: 8px; cursor: pointer; }
        
        /* Mesajlar */
        .message { margin-bottom: 15px; background: #000; padding: 15px; border-radius: 8px; border: 1px solid var(--border); }
        .msg-header { font-size: 12px; color: #a1a1aa; margin-bottom: 5px; font-weight: bold; display: flex; justify-content: space-between; }
        .msg-text { font-size: 14px; color: #e4e4e7; white-space: pre-wrap; }

        /* Hata Kutusu */
        .error-box { padding: 20px; background: rgba(239, 68, 68, 0.1); border: 1px solid #ef4444; color: #ef4444; border-radius: 8px; text-align: center; margin-top: 20px; }
    </style>
</head>
<body>

    <div class="sidebar">
        <h3 style="color:white;">Dark Security</h3>
        <div style="color:#a1a1aa; font-size:12px;">DEBUG MODU</div>
    </div>

    <div class="main">
        <div class="header">Debug Konsolu</div>
        
        <div class="chat-area" id="chat-feed">
            <div style="text-align:center; color:gray; margin-top:20px;">
                <i class="fa-solid fa-circle-notch fa-spin"></i> Bağlantı kontrol ediliyor...
            </div>
        </div>

        <div class="chat-input-bar">
            <textarea id="main-chat-input" class="chat-input" placeholder="Mesaj yaz..."></textarea>
            <button id="main-send-btn" class="send-btn"><i class="fa-solid fa-paper-plane"></i></button>
        </div>
    </div>

    <script>
        const API_URL = 'https://admin3131.pythonanywhere.com';

        // --- HATA DETEKTÖRÜ ---
        async function loadMessages() {
            const feed = document.getElementById('chat-feed');
            
            try {
                // 1. ADIM: İSTEK AT
                console.log("İstek gönderiliyor: " + API_URL + "/posts");
                const res = await fetch(`${API_URL}/posts`, { credentials: 'include' });

                // 2. ADIM: HTTP KODUNU KONTROL ET
                console.log("Sunucu Cevabı:", res.status);
                if (!res.ok) {
                    throw new Error(`Sunucu Hatası: ${res.status} ${res.statusText}`);
                }

                // 3. ADIM: JSON ÇEVİR
                let posts;
                try {
                    posts = await res.json();
                } catch (jsonErr) {
                    throw new Error("Veri JSON formatında değil! Muhtemelen HTML hata sayfası dönüyor.");
                }

                // 4. ADIM: VERİ TİPİ KONTROLÜ
                if (!Array.isArray(posts)) {
                    console.log("Gelen bozuk veri:", posts);
                    if(posts.error) throw new Error("Sunucu Mesajı: " + posts.error);
                    throw new Error("Gelen veri LİSTE değil! Şunu gönderdi: " + JSON.stringify(posts));
                }

                if (posts.length === 0) {
                    feed.innerHTML = "<div style='text-align:center; color:gray;'>Mesaj yok.</div>";
                    return;
                }

                // 5. ADIM: EKRANA BAS
                let html = posts.map(p => `
                    <div class="message">
                        <div class="msg-header">
                            <span>${p.author_email || 'Anonim'}</span>
                            <span>${new Date(p.created_at).toLocaleTimeString()}</span>
                        </div>
                        <div class="msg-text">${p.content}</div>
                    </div>
                `).join('');
                
                feed.innerHTML = html;
                
            } catch (e) {
                // HATAYI EKRANA BAS
                console.error(e);
                feed.innerHTML = `
                    <div class="error-box">
                        <h3><i class="fa-solid fa-triangle-exclamation"></i> BİR HATA OLUŞTU</h3>
                        <p style="font-weight:bold; font-size:16px;">${e.message}</p>
                        <p style="font-size:12px; margin-top:10px;">Lütfen bu hatayı kopyalayıp bana söyle.</p>
                        <button onclick="location.reload()" style="background:#ef4444; color:white; border:none; padding:8px 16px; border-radius:4px; cursor:pointer; margin-top:10px;">Sayfayı Yenile</button>
                    </div>
                `;
            }
        }

        // Gönder Butonu (Test için)
        document.getElementById('main-send-btn').onclick = async () => {
            const content = document.getElementById('main-chat-input').value;
            try {
                const res = await fetch(`${API_URL}/posts`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ content: content, parent_id: null }),
                    credentials: 'include'
                });
                const data = await res.json();
                if(res.ok) { loadMessages(); document.getElementById('main-chat-input').value = ''; }
                else { alert("Hata: " + (data.error || "Bilinmiyor")); }
            } catch(e) { alert("Gönderme Hatası: " + e.message); }
        };

        // Başlat
        loadMessages();
    </script>
</body>
</html>
